[sal@localhost sals_tests]$ ./run_3flows.sh tc202_data_setup.sh
now calling ./run_3flows.sh tc202_data_setup.sh ..
mylist=tc202_data_setup.sh
cleaning out /opt/app/sas/custom/data
creating /opt/app/sas/custom/data
creating /opt/app/sas/custom/data/error_messages
creating /opt/app/sas/custom/data/pcrf_files_prepaid
creating /opt/app/sas/custom/data/pcrf_files_postpaid
creating /opt/app/sas/custom/data/lookup_paymenttype
creating /opt/app/sas/custom/data/lookup_recurring/OUT
creating /opt/app/sas/custom/data/output_prepaid
creating /opt/app/sas/custom/data/output_postpaid
creating /opt/app/sas/custom/data/output_fonic
creating /opt/app/sas/custom/data/bad_server_events
creating /opt/app/sas/custom/data/persist_fonic_throttle_event
creating /opt/app/sas/custom/data/persist_prepaid_throttle_event
creating /opt/app/sas/custom/data/persist_postpaid_throttle_event
############################################################################
starting tc202 at Wed Apr  9 17:15:10 CEST 2014..
running test at Wed Apr  9 17:15:10 CEST 2014
tc202:
R9: No PCRF EDR entries are skipped
if there is a mix of data, all EDRs are processed idependently of each other
in other words, none are skipped (a bug seen in previous versions of this software)
 
 
test strategy:
we try various valid and invalid prepaid throttle 100 events and make sure
the good ones are cleanly processed and none are skipped (this was a bug in the CEP engine!!!!)
 
EDR data setup:
Row1: a valid PREPAID throttle 100 event (Quota_Name=Q_110_local_Month, TriggerType=2, Quota_Status=6, QuotaValue=1)
Row2: a valid PREPAID throttle 100 event
Row3: a not valid PREPAID throttle 100 event (TriggerType=7 instead of 1-6)
Row4: a not valid PREPAID throttle 100 event (Quota_Status=4 instead of 6)
Row5: a not valid PREPAID throttle 100 event (QuotaValue=11 instead of 1)
Row6: a POSTPAID throttle 100 event - it should be igonored
Row7: a FONIC throttle 100 event - it should be igonored
Row8: a PREPAID throttle 100 event - it should be processed
 

tc202: 1. PCRF EDRs (input stream)..
tc202: 2. paymenttype lkp..
tc202: 3. recurring lkp..
  adding: tc202_input_data_recurring_lkp.txt (deflated 66%)
debug ls -rtl /opt/app/sas/custom/data/lookup_recurring/OUT
total 8
-rw-rw-r--. 1 sal sal 156 Apr  9 17:15 tc202_input_data_recurring_lkp.txt
-rw-rw-r--. 1 sal sal 271 Apr  9 17:15 tc202_input_data_recurring_lkp.txt.zip
-rw-rw-r--. 1 sal sal   0 Apr  9 17:15 tc202_input_data_recurring_lkp.txt.zip.done
tc202: 4. generating the expected output..
 
here is the contents we were looking for..
I,N:2014-04-09 17:15:10,4912345678901,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,Y,1230
I,N:2014-04-09 17:15:10,4912345678902,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,Y,1230
I,N:2014-04-09 17:15:10,4912345678908,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,,
 
here is the payment_type lookup we used..
4912345678901,PREPAID
4912345678902,PREPAID
4912345678903,PREPAID
4912345678904,PREPAID
4912345678905,PREPAID
4912345678906,POSTPAID
4912345678907,FONIC
4912345678908,PREPAID
 
here is the recurring lookup we used..
4912345678901,Q_110_local_Month,1230,Y
4912345678902,Q_110_local_Month,1230,Y
4912345678903,Q_110_local_Month,1230,Y
4912345678904,Q_110_local_Month,1230,Y
 
here is the EDR stream we used..
2,2014-04-09 17:15:10,,,4912345678901,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
2,2014-04-09 17:15:10,,,4912345678902,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
7,2014-04-09 17:15:10,,,4912345678903,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
2,2014-04-09 17:15:10,,,4912345678904,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,4,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
2,2014-04-09 17:15:10,,,4912345678905,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,11,,
2,2014-04-09 17:15:10,,,4912345678906,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
2,2014-04-09 17:15:10,,,4912345678907,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
2,2014-04-09 17:15:10,,,4912345678908,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,Q_110_local_Month,6,12,,,1024,2014-04-25 17:15:10,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,
calling ./START_CEP_ENGINE.sh  
cd /home/sal/Desktop/dev/2.2-pre/bin
starting the cep server at Wed Apr  9 17:15:10 CEST 2014..
./dfesp_xml_server -pubsub 55555 -server 55556 -loglevel debug -badevents /opt/app/sas/custom/data/bad_server_events/bad_events.txt >> /home/sal/sals_tests/cep_server.log
running in the following cep server process..
sal      34024  1.0  0.7 518076 13792 pts/0    Sl+  17:15   0:00 ./dfesp_xml_server -pubsub 55555 -server 55556 -loglevel debug -badevents /opt/app/sas/custom/data/bad_server_events/bad_events.txt
calling ./START_CEP_MODEL.sh PREPAID_THROTTLE_EVENT 
cd /home/sal/Desktop/dev/2.2-pre/bin
1/3) loading the cep model at Wed Apr  9 17:15:13 CEST 2014..
./dfesp_xml_client -server localhost.localdomain:55556 -file /home/sal/sals_tests/start_stop_dir/PREPAID_THROTTLE_EVENT_load.xml
<response action='load' name='PREPAID_THROTTLE_EVENT' pubsub='auto' threads='4' use-tagged-token='true' elapsed='64 ms'>
    <message>project load PREPAID_THROTTLE_EVENT succeeded</message>
</response>

2/3) starting the cep model..
./dfesp_xml_client -server localhost.localdomain:55556 -file /home/sal/sals_tests/start_stop_dir/PREPAID_THROTTLE_EVENT_start.xml
 
<response action='start' name='PREPAID_THROTTLE_EVENT' elapsed='0 ms'>
    <message>project PREPAID_THROTTLE_EVENT started</message>
</response>

3/3) restoring an existing binaries for this cep model..
./dfesp_xml_client -server localhost.localdomain:55556 -file /home/sal/sals_tests/start_stop_dir/PREPAID_THROTTLE_EVENT_restore.xml
 
<response restore='/opt/app/sas/custom/data/persist_prepaid_throttle_event' elapsed='0 ms'/>

calling ./START_CEP_ADAPTER.sh  
cd /home/sal/sals_tests/try11
starting the cep adapter.. java -Dorg.apache.camel.jmx.createRmiConnector -Dcom.sun.management.jmxremote.authenticate -jar o2-adapters-pcrf-2.12.2.jar >> /home/sal/sals_tests/cep_adapter.log
running in the following cep adapter process..
sal      34129 50.5  2.7 1293736 51928 pts/0   Sl+  17:15   0:01 java -Dorg.apache.camel.jmx.createRmiConnector -Dcom.sun.management.jmxremote.authenticate -jar o2-adapters-pcrf-2.12.2.jar
waiting for /opt/app/sas/custom/data/output_prepaid/result.csv to be created..
######################
debug2 my_waits=1, max_count=70
######################
tc202:11. now we can compare results..
here is the contents we were looking for..
I,N:2014-04-09 17:15:10,4912345678901,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,Y,1230
I,N:2014-04-09 17:15:10,4912345678902,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,Y,1230
I,N:2014-04-09 17:15:10,4912345678908,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,,
here is what we got..
I,N:2014-04-09 17:15:10,4912345678908,0,1.2.3.4,Q_110_local_Month,12,2014-04-25 17:15:10,2,,,,,,,,,,,0,,,,,,1.2.3.4,,,,,,,6,12,,,1024,,,,,,,,,,PREPAID,1024,,
tc202: RESULT: FAILURE!!! output doesnt match the input
calling ./STOP_CEP_ADAPTER.sh  
killing 34129..
waiting on the following processes to stop..

calling ./STOP_CEP_MODEL.sh PREPAID_THROTTLE_EVENT 
cd /home/sal/Desktop/dev/2.2-pre/bin
1/3) persisting the cep model at Wed Apr  9 17:15:30 CEST 2014..
./dfesp_xml_client -server localhost.localdomain:55556 -file /home/sal/sals_tests/start_stop_dir/PREPAID_THROTTLE_EVENT_persist.xml
<response path='/opt/app/sas/custom/data/persist_prepaid_throttle_event' project='PREPAID_THROTTLE_EVENT' elapsed='5 ms'>
    <message>project 'PREPAID_THROTTLE_EVENT' successfully saved to '/opt/app/sas/custom/data/persist_prepaid_throttle_event'</message>
</response>

2/3) stopping the cep model..
./dfesp_xml_client -server localhost.localdomain:55556 -file /home/sal/sals_tests/start_stop_dir/PREPAID_THROTTLE_EVENT_stop.xml
 
<response action='start' name='PREPAID_THROTTLE_EVENT' elapsed='0 ms'>
    <message>project PREPAID_THROTTLE_EVENT started</message>
</response>

3/3) removing the cep model from memory..
./dfesp_xml_client -server localhost.localdomain:55556 -file /home/sal/sals_tests/start_stop_dir/PREPAID_THROTTLE_EVENT_remove.xml
 
calling ./STOP_CEP_ENGINE.sh  
killing 34024..
waiting on the following processes to stop..
*** glibc detected *** ./dfesp_xml_server: double free or corruption (fasttop): 0x00007f23c8113da0 ***
======= Backtrace: =========
/lib64/libc.so.6[0x38ed676166]
/home/sal/Desktop/dev/2.2-pre/lib/libdfxesp-2.2.so(_ZN16dfESPthreadUtils6threadD1Ev+0x38)[0x7f23ef7145a8]
/home/sal/Desktop/dev/2.2-pre/lib/libdfxesp-2.2.so(_ZN17dfESPpubsubServer4stopEv+0x5f6)[0x7f23ef6fbdf6]
/home/sal/Desktop/dev/2.2-pre/lib/libdfxesp-2.2.so(_ZN12dfESPproject11stopProjectEv+0x9b)[0x7f23ef6f2d2b]
./dfesp_xml_server[0x46e1df]
./dfesp_xml_server[0x50d0ca]
./dfesp_xml_server[0x50e523]
./dfesp_xml_server(_ZN6Thread5entryEPv+0x115)[0x453985]
/lib64/libpthread.so.0[0x38eda079d1]
/lib64/libc.so.6(clone+0x6d)[0x38ed6e8b6d]
======= Memory map: ========
00400000-0054a000 r-xp 00000000 08:02 407496                             /home/sal/Desktop/dev/2.2-pre/bin/dfesp_xml_server
00749000-0074f000 rw-p 00149000 08:02 407496                             /home/sal/Desktop/dev/2.2-pre/bin/dfesp_xml_server
0074f000-00751000 rw-p 00000000 00:00 0 
013c6000-0145f000 rw-p 00000000 00:00 0                                  [heap]
38ece00000-38ece20000 r-xp 00000000 08:02 406175                         /lib64/ld-2.12.so
38ed01f000-38ed020000 r--p 0001f000 08:02 406175                         /lib64/ld-2.12.so
38ed020000-38ed021000 rw-p 00020000 08:02 406175                         /lib64/ld-2.12.so
38ed021000-38ed022000 rw-p 00000000 00:00 0 
38ed200000-38ed202000 r-xp 00000000 08:02 406487                         /lib64/libdl-2.12.so
38ed202000-38ed402000 ---p 00002000 08:02 406487                         /lib64/libdl-2.12.so
38ed402000-38ed403000 r--p 00002000 08:02 406487                         /lib64/libdl-2.12.so
38ed403000-38ed404000 rw-p 00003000 08:02 406487                         /lib64/libdl-2.12.so
38ed600000-38ed78b000 r-xp 00000000 08:02 406405                         /lib64/libc-2.12.so
38ed78b000-38ed98a000 ---p 0018b000 08:02 406405                         /lib64/libc-2.12.so
38ed98a000-38ed98e000 r--p 0018a000 08:02 406405                         /lib64/libc-2.12.so
38ed98e000-38ed98f000 rw-p 0018e000 08:02 406405                         /lib64/libc-2.12.so
38ed98f000-38ed994000 rw-p 00000000 00:00 0 
38eda00000-38eda17000 r-xp 00000000 08:02 406481                         /lib64/libpthread-2.12.so
38eda17000-38edc17000 ---p 00017000 08:02 406481                         /lib64/libpthread-2.12.so
38edc17000-38edc18000 r--p 00017000 08:02 406481                         /lib64/libpthread-2.12.so
38edc18000-38edc19000 rw-p 00018000 08:02 406481                         /lib64/libpthread-2.12.so
38edc19000-38edc1d000 rw-p 00000000 00:00 0 
38ede00000-38ede07000 r-xp 00000000 08:02 406482                         /lib64/librt-2.12.so
38ede07000-38ee006000 ---p 00007000 08:02 406482                         /lib64/librt-2.12.so
38ee006000-38ee007000 r--p 00006000 08:02 406482                         /lib64/librt-2.12.so
38ee007000-38ee008000 rw-p 00007000 08:02 406482                         /lib64/librt-2.12.so
38ee200000-38ee283000 r-xp 00000000 08:02 406484                         /lib64/libm-2.12.so
38ee283000-38ee482000 ---p 00083000 08:02 406484                         /lib64/libm-2.12.so
38ee482000-38ee483000 r--p 00082000 08:02 406484                         /lib64/libm-2.12.so
38ee483000-38ee484000 rw-p 00083000 08:02 406484                         /lib64/libm-2.12.so
38f8a00000-38f8a71000 r-xp 00000000 08:02 406497                         /lib64/libfreebl3.so
38f8a71000-38f8c70000 ---p 00071000 08:02 406497                         /lib64/libfreebl3.so
38f8c70000-38f8c72000 r--p 00070000 08:02 406497                         /lib64/libfreebl3.so
38f8c72000-38f8c73000 rw-p 00072000 08:02 406497                         /lib64/libfreebl3.so
38f8c73000-38f8c77000 rw-p 00000000 00:00 0 
38f8e00000-38f8e16000 r-xp 00000000 08:02 406509                         /lib64/libgcc_s-4.4.7-20120601.so.1
38f8e16000-38f9015000 ---p 00016000 08:02 406509                         /lib64/libgcc_s-4.4.7-20120601.so.1
38f9015000-38f9016000 rw-p 00015000 08:02 406509                         /lib64/libgcc_s-4.4.7-20120601.so.1
38f9600000-38f9607000 r-xp 00000000 08:02 406498                         /lib64/libcrypt-2.12.so
38f9607000-38f9807000 ---p 00007000 08:02 406498                         /lib64/libcrypt-2.12.so
38f9807000-38f9808000 r--p 00007000 08:02 406498                         /lib64/libcrypt-2.12.so
38f9808000-38f9809000 rw-p 00008000 08:02 406498                         /lib64/libcrypt-2.12.so
38f9809000-38f9837000 rw-p 00000000 00:00 0 
38f9a00000-38f9ae8000 r-xp 00000000 08:02 679582                         /usr/lib64/libstdc++.so.6.0.13
38f9ae8000-38f9ce8000 ---p 000e8000 08:02 679582                         /usr/lib64/libstdc++.so.6.0.13
38f9ce8000-38f9cef000 r--p 000e8000 08:02 679582                         /usr/lib64/libstdc++.so.6.0.13
38f9cef000-38f9cf1000 rw-p 000ef000 08:02 679582                         /usr/lib64/libstdc++.so.6.0.13
38f9cf1000-38f9d06000 rw-p 00000000 00:00 0 
7f23ac000000-7f23ac021000 rw-p 00000000 00:00 0 
7f23ac021000-7f23b0000000 ---p 00000000 00:00 0 
7f23b0000000-7f23b0021000 rw-p 00000000 00:00 0 
7f23b0021000-7f23b4000000 ---p 00000000 00:00 0 
7f23b5bfd000-7f23b5bfe000 ---p 00000000 00:00 0 
7f23b5bfe000-7f23b65fe000 rwxp 00000000 00:00 0 
7f23b8000000-7f23ba008000 rw-p 00000000 00:00 0 
7f23ba008000-7f23bc000000 ---p 00000000 00:00 0 
7f23be5f7000-7f23be5f8000 ---p 00000000 00:00 0 
7f23be5f8000-7f23beff8000 rwxp 00000000 00:00 0 
7f23beff8000-7f23beff9000 ---p 00000000 00:00 0 
7f23beff9000-7f23bf9f9000 rwxp 00000000 00:00 0 
7f23c4000000-7f23c4021000 rw-p 00000000 00:00 0 
7f23c4021000-7f23c8000000 ---p 00000000 00:00 0 
7f23c8000000-7f23c8128000 rw-p 00000000 00:00 0 
7f23c8128000-7f23cc000000 ---p 00000000 00:00 0 
7f23cc3fa000-7f23cc3fb000 ---p 00000000 00:00 0 
7f23cc3fb000-7f23ccdfb000 rwxp 00000000 00:00 0 
7f23cebfe000-7f23cebff000 ---p 00000000 00:00 0 
7f23cebff000-7f23cf5ff000 rwxp 00000000 00:00 0 
7f23cf5ff000-7f23cf600000 ---p 00000000 00:00 0 
7f23cf600000-7f23d0000000 rwxp 00000000 00:00 0 
7f23d0000000-7f23d0021000 rw-p 00000000 00:00 0 
7f23d0021000-7f23d4000000 ---p 00000000 00:00 0 
7f23d4000000-7f23d4021000 rw-p 00000000 00:00 0 
7f23d4021000-7f23d8000000 ---p 00000000 00:00 0 
7f23d8000000-7f23d8021000 rw-p 00000000 00:00 0 
7f23d8021000-7f23dc000000 ---p 00000000 00:00 0 
7f23dc14b000-7f23dc14c000 ---p 00000000 00:00 0 
7f23dc14c000-7f23dcb4c000 rwxp 00000000 00:00 0 
7f23dcb4c000-7f23dcb8c000 rw-p 00000000 00:00 0 
7f23dcb8c000-7f23dcbc3000 r-xp 00000000 08:02 406801                     /home/sal/Desktop/dev/2.2-pre/lib/tkts/tkepdl.so
7f23dcbc3000-7f23dcdc2000 ---p 00037000 08:02 406801                     /home/sal/Desktop/dev/2.2-pre/lib/tkts/tkepdl.so
7f23dcdc2000-7f23dcdc4000 rw-p 00036000 08:02 406801                  34024
ending tc202 at Wed Apr  9 17:15:38 CEST 2014..
############################################################################
[sal@localhost sals_tests]$ 


